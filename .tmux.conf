# vim: ft=tmux

# Don't create login shells
set -g default-command "${SHELL}"

# setting the prefix from C-b to C-a
set -g prefix C-space

# use Ctrl-B for nested session prefix
bind -n C-b send-prefix

# xterm-style function key sequences
setw -g xterm-keys on

# https://github.com/tmux/tmux/wiki/FAQ#what-is-the-passthrough-escape-sequence-and-how-do-i-use-it
set -g allow-passthrough on

# improve colors
set -ga terminal-overrides ",*256col*:Tc"

# Ms modifies OSC 52 clipboard handling to work with mosh, see
# https://gist.github.com/yudai/95b20e3da66df1b066531997f982b57b
# set -ga terminal-overrides "vte*:XT:Ms=\\E]52;c;%p2%s\\7,xterm*:XT:Ms=\\E]52;c;%p2%s\\7"

# enable OSC 52 clipboard
# https://medium.freecodecamp.org/tmux-in-practice-integration-with-system-clipboard-bcd72c62ff7b
set -g set-clipboard on

# undercurl support
set -g default-terminal "${TERM}"
set-option -sa terminal-features ",*:RGB"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# vim/tmux focus integration
set-option -g focus-events on

# free the original Ctrl-b prefix keybinding
unbind C-b

# setting the delay between prefix and command
set -sg escape-time 0

# Lots of history
set -g history-limit 100000

# set the base index for windows to 1 instead of 0
set -g base-index 1

# set the base index for panes to 1 instead of 0
setw -g pane-base-index 1

# edit configuration
bind e new-window -n '~/.tmux.conf' '${EDITOR:-nvim} ~/.tmux.conf && tmux source ~/.tmux.conf && tmux display "~/.tmux.conf sourced"'

# reload the file with Prefix r
bind r source-file ~/.tmux.conf \; display "~/.tmux.conf sourced"

# don't resize to smallest client
set -g aggressive-resize off

# -- navigation ----------------------------------------------------------------

# create session
bind C-c new-session

# fix shift-enter
bind -n S-Enter send-keys "[13;2u"
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

# find session
bind C-f command-prompt -p find-session 'switch-client -t %%'

# switch to previous session
bind-key z switch-client -l

# splitting panes
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

# quick window selection
bind -r C-h select-window -t :-
bind -r C-l select-window -t :+
bind Space last-window

# alt-number to select window/tab
bind -n Â¡ select-window -t 1
bind -n â„¢ select-window -t 2
bind -n Â£ select-window -t 3
bind -n Â¢ select-window -t 4
bind -n âˆž select-window -t 5
bind -n Â§ select-window -t 6

# move windows with shift-left/right
bind-key -r S-Left swap-window -d -t -1
bind-key -r S-Right swap-window -d -t +1

# search back to previous prompt with <binding>-.
unbind .
bind-key . copy-mode\;\
           send-keys -X search-backward "Â "\;\
           send-keys -X search-again;

# enable activity alerts
setw -g monitor-activity on
set -g visual-activity on

# set the pane border colors
set -g pane-border-style fg=colour250,bg=colour236
set -g pane-active-border-style fg=green,bg=colour236

# pane number display
set-option -g display-panes-active-colour colour33 #blue
set-option -g display-panes-colour colour166 #orange

# Command / message line
set -g message-style fg=colour166,bg=colour235

# enable vi keys.
setw -g mode-keys vi

# Toggle focus with f/F8
unbind f
bind-key f resize-pane -Z
bind-key -n F8 resize-pane -Z

# Resizing commands
unbind %
bind-key = select-layout even-vertical
bind-key % select-layout even-horizontal
bind-key -r K resize-pane -U 2
bind-key -r J resize-pane -D 2
bind-key -r H resize-pane -L 2
bind-key -r L resize-pane -R 2

# clear line
bind u send-keys C-k \; send-keys C-u

bind > swap-pane -D  # swap current pane with the next one
bind < swap-pane -U  # swap current pane with the previous on

# move between windows
bind -r l next-window     # move right
bind -r h previous-window # move left

# Setup 'v' to begin selection as in Vim
unbind [
bind u copy-mode

# vi copy mode
run -b 'tmux bind -T copy-mode-vi v   send -X begin-selection 2> /dev/null || true'
run -b 'tmux bind -T copy-mode-vi V   send -X begin-selection 2> /dev/null || true'
run -b 'tmux bind -T copy-mode-vi C-v send -X rectangle-toggle 2> /dev/null || true'
run -b 'tmux bind -T copy-mode-vi H   send -X start-of-line 2> /dev/null || true'
run -b 'tmux bind -T copy-mode-vi L   send -X end-of-line 2> /dev/null || true'
run -b 'tmux bind -T copy-mode-vi u   send -X halfpage-up 2> /dev/null || true'
run -b 'tmux bind -T copy-mode-vi d   send -X halfpage-down 2> /dev/null || true'

# update default binding of `Enter` to also use copy-pipe
if-shell 'hash pbcopy 2>/dev/null' 'bind-key -T copy-mode-vi y     send -X copy-pipe-and-cancel "pbcopy"'
if-shell 'hash pbcopy 2>/dev/null' 'bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"'

# use "Y" to copy selected text and immediately paste it
if-shell 'hash pbcopy 2>/dev/null' 'bind-key -T copy-mode-vi "Y"   send-keys -X copy-pipe-and-cancel "pbcopy; tmux paste-buffer"'

# paste buffer management
bind b list-buffers  # list paste buffers
bind p paste-buffer  # paste from the top paste buffer
bind P choose-buffer # choose which buffer to paste from

# mouse support
set -g -q mouse on

# make mousewheel work when not in copy mode
bind-key -T root WheelUpPane if-shell -F -t = "#{alternate_on}" "send-keys -M" "select-pane -t =; copy-mode -e; send-keys -M"
bind-key -T root WheelDownPane if-shell -F -t = "#{alternate_on}" "send-keys -M" "select-pane -t =; send-keys -M"
bind-key -T copy-mode-vi WheelUpPane   send -X halfpage-up
bind-key -T copy-mode-vi WheelDownPane send -X halfpage-down

# allow naming panes by term codes
setw -g automatic-rename on
set -g set-titles on

# renumber panes on closeures
set -g renumber-windows on

# remove administrative debris (session name, hostname, time) in status bar
set -g status-left ''
set -g status-right ''

# status bar settings adapted from powerline
set -g status on
set -g status-interval 10
set -g status-fg colour231
set -g status-bg colour234
set -g status-left-length 20
set -g status-left '#{?client_prefix,#[fg=colour254]#[bg=colour31]#[bold],#[fg=colour16]#[bg=colour254]#[bold]} #S #{?client_prefix,#[fg=colour31]#[bg=colour234]#[nobold],#[fg=colour254]#[bg=colour234]#[nobold]}î‚°'
set -g status-right-length 150
set -g window-status-format "#[fg=colour244,bg=colour234]#I #[fg=colour240]î‚± #[default]#W "
set -g window-status-current-format "#[fg=colour234,bg=colour31]î‚°#[fg=colour117,bg=colour31] #I î‚± #[fg=colour231,bold]#W #[fg=colour31,bg=colour234,nobold]î‚°"
set -g window-status-last-style fg=colour31

set -g window-status-style fg=colour249
set -g window-status-activity-style fg=yellow
set -g window-status-bell-style fg=red

# Use complex status bar only if plugins are available, simple one otherwise
if-shell '[ -d ~/.tmux/plugins/tmux-cpu ]' \
  'set -g status-right "#{cpu_fg_color}CPU: #{cpu_icon} #{cpu_percentage}#[default] | #{battery_status_fg}Batt: #{battery_icon} #{battery_percentage} #{battery_remain}#[default]"' \
  'set -g status-right "#[fg=colour240] %Y-%m-%d %H:%M "'

set -g @extrakto_filter_order "word quote s-quote path url"

set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'laktak/extrakto'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'Morantron/tmux-fingers'
set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-cpu'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
